language: java
sudo: false

services:
  - docker

before_install:
  # make comparing to origin/master work
  - git remote set-branches --add origin master && git fetch
  # fetch full history for correct current and previous version detection
  - git fetch --unshallow
  # using jabba for custom jdk management
  - curl -sL https://raw.githubusercontent.com/shyiko/jabba/0.11.0/install.sh | bash && . ~/.jabba/jabba.sh
  - jabba install adopt@1.8.192-12

# default script for jobs, that do not have any specified
script:
  - jabba use ${JDK:=adopt@1.8.192-12}
  - java -version
  - ${PRE_CMD:=return 0} # do nothing if not set

jobs:
  include:
    - stage: check
      script: ./mvnw test-compile
      name: "Compile all tests (with Java=${JDK} )"

    - stage: unit-test
    - env: CMD=./mvnw -pl autoconfigure test
    - env: CMD=./mvnw -pl storage test

    - stage: it-test
    - env: CMD=./mvnw -pl storage integration-test
    - env: CMD=./mvnw -pl autoconfigure integration-test

cache:
  directories:
    - $HOME/.jabba/jdk
  timeout: 900